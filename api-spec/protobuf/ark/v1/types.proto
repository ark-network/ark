syntax = "proto3";

package ark.v1;

/* Types */

message Outpoint {
  string txid = 1;
  uint32 vout = 2;
}

message Input {
  Outpoint outpoint = 1;
  Tapscripts taproot_tree = 2;
}

message Output {
  string address = 1; // onchain or off-chain
  uint64 amount = 2; // Amount to send in satoshis.
}

message Tree {
  repeated TreeLevel levels = 1;
}

message TreeLevel {
  repeated Node nodes = 1;
}

message Node {
  string txid = 1;
  string tx = 2;
  string parent_txid = 3;
  int32 level = 4;
  int32 level_index = 5;
  bool leaf = 6;
}

message Vtxo {
  Outpoint outpoint = 1;
  uint64 amount = 2;
  string script = 3;
  int64 created_at = 4;
  int64 expires_at = 5;
  string commitment_txid = 6;
  bool preconfirmed = 7;
  bool swept = 8;
  bool redeemed = 9;
  bool spent = 10;
  string spent_by = 11;
}

message TxNotification {
  string txid = 1;
  repeated Vtxo spent_vtxos = 2;
  repeated Vtxo spendable_vtxos = 3;
  string hex = 5;
}

message Tapscripts {
  repeated string scripts = 1;
}

message Bip322Signature {
  string signature = 1;
  string message = 2;
}

message MarketHour {
  int64 next_start_time = 1;
  int64 next_end_time = 2;
  int64 period = 3;
  int64 round_interval = 4;
}

/* Events */

message BatchStartedEvent {
  string id = 1;
  repeated string intent_id_hashes = 2;
  int64 batch_expiry = 3;
}

message BatchFinalizationEvent {
  string id = 1;
  string commitment_tx = 2;
  // vtxo outpoint encoded as string -> connector outpoint
  map<string, Outpoint> connectors_index = 3;
}

message BatchFinalizedEvent {
  string id = 1;
  string commitment_txid = 2;
}

message BatchFailed {
  string id = 1;
  string reason = 2;
}

message TreeSigningStartedEvent {
  string id = 1;
  repeated string cosigners_pubkeys = 2;
  string unsigned_commitment_tx = 3;
}

message TreeNoncesAggregatedEvent {
  string id = 1;
  string tree_nonces = 2;
}

message TreeTxEvent {
  string id = 1;
  repeated string topic  = 2;
  int32 batch_index = 3;
  Node tree_tx = 4;
}

message TreeSignatureEvent {
  string id = 1;
  repeated string topic = 2;
  int32 batch_index = 3;
  int32 level = 4;
  int32 level_index = 5;
  string signature = 6;
}